<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¯ å›¾åƒåˆ†ç±»è®­ç»ƒå¹³å°</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@latest/dist/mobilenet.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #ff6b6b, #ff8e53);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .main-content {
            padding: 30px;
        }
        
        .step-section {
            margin: 30px 0;
            padding: 25px;
            border: 2px solid #f0f0f0;
            border-radius: 15px;
            background: #fafafa;
        }
        
        .step-title {
            color: #333;
            font-size: 1.5em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        
        .step-number {
            background: #ff6b6b;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-weight: bold;
        }
        
        .classes-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .class-card {
            background: white;
            border: 2px solid #ddd;
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .class-card:hover {
            border-color: #ff6b6b;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .class-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .class-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            border: none;
            border-bottom: 2px solid #ff6b6b;
            padding: 5px;
            width: 150px;
            text-align: center;
        }
        
        .image-stats {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
        }
        
        .image-upload {
            border: 3px dashed #ccc;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            background: #f9f9f9;
        }
        
        .image-upload:hover {
            border-color: #ff6b6b;
            background: #fff5f5;
        }
        
        .image-upload.dragover {
            border-color: #ff6b6b;
            background: #ffe0e0;
        }
        
        .upload-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .image-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .preview-item {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #eee;
            transition: transform 0.2s;
        }
        
        .preview-item:hover {
            transform: scale(1.1);
        }
        
        .preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .remove-btn {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .training-section {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 15px;
            margin: 20px 0;
        }
        
        .train-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2em;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
        }
        
        .train-btn:hover:not(:disabled) {
            background: #ff5252;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .train-btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .progress-container {
            margin: 20px 0;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.3);
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: #4CAF50;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .training-details {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: left;
        }
        
        .prediction-section {
            display: none;
            text-align: center;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 15px;
            margin: 20px 0;
        }
        
        .prediction-result {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
            margin: 30px 0;
        }
        
        .result-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            text-align: center;
            min-width: 180px;
            transition: all 0.3s ease;
            border: 3px solid transparent;
        }
        
        .result-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 30px rgba(0,0,0,0.2);
        }
        
        .result-card.winner {
            border: 3px solid #FFD700;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
            50% { box-shadow: 0 8px 25px rgba(255,215,0,0.4); }
            100% { box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
        }
        
        .result-card h4 {
            font-size: 1.3em;
            margin-bottom: 15px;
            font-weight: bold;
        }
        
        .result-card p {
            font-size: 1.5em;
            font-weight: bold;
            color: #FFD700;
        }
        
        .result-card.winner p {
            color: #FFD700;
            font-size: 1.8em;
        }
        
        .confidence-bar {
            width: 120px;
            height: 12px;
            background: rgba(255,255,255,0.3);
            border-radius: 6px;
            overflow: hidden;
            margin: 15px auto;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #FFD700, #FFA500);
            transition: width 0.5s ease;
            border-radius: 6px;
        }
        
        .file-input {
            display: none;
        }
        
        .status-message {
            margin: 10px 0;
            font-size: 1.1em;
            font-weight: bold;
        }
        
        .add-class-btn {
            background: #2196f3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            margin: 10px 0;
            font-size: 1em;
        }
        
        .remove-class-btn {
            background: #ff4757;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.8em;
        }
        
        .test-upload {
            max-width: 400px;
            margin: 20px auto;
        }
        
        .test-preview {
            width: 250px;
            height: 250px;
            margin: 20px auto;
            border: 3px solid #667eea;
            border-radius: 15px;
            display: none;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(102,126,234,0.3);
            transition: all 0.3s ease;
        }
        
        .test-preview:hover {
            transform: scale(1.05);
            box-shadow: 0 12px 35px rgba(102,126,234,0.4);
        }
        
        .test-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .model-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .metric-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-3px);
        }
        
        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .metric-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-top: 5px;
        }
        
        .tips {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .tips h4 {
            color: #856404;
            margin-bottom: 10px;
        }
        
        .tips ul {
            color: #856404;
            padding-left: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ å›¾åƒåˆ†ç±»è®­ç»ƒå¹³å°ä¸“ä¸šç‰ˆ</h1>
           
        </div>
        
        <div class="main-content">
            <!-- è®­ç»ƒæç¤º -->
            <div class="tips">
                <h4>ğŸ’¡ è®­ç»ƒå°è´´å£«</h4>
                <div class="training-guide">
                    <h3 style="color: #007bff; margin-bottom: 15px;">ğŸ¯ è®­ç»ƒæŒ‡å—</h3>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 4px solid #007bff;">
                        <h4 style="color: #007bff; margin-bottom: 10px;">ğŸ“Š æ•°æ®å‡†å¤‡å»ºè®®</h4>
                        <ul style="margin: 0; padding-left: 20px; color: #666; line-height: 1.8;">
                            <li><strong>æ•°æ®é‡ï¼š</strong>æ¯ç±»è‡³å°‘20å¼ å›¾ç‰‡ï¼Œè¶Šå¤šè¶Šå¥½ï¼ˆå»ºè®®15-20å¼ ä¸åŒè§’åº¦ã€å…‰ç…§ï¼‰</li>
                            <li><strong>å›¾ç‰‡è´¨é‡ï¼š</strong>æ¸…æ™°ã€æ­£é¢ã€å…‰çº¿å……è¶³ï¼Œä¸»ä½“çªå‡ºï¼Œé¿å…èƒŒæ™¯è¿‡äºå¤æ‚</li>
                            <li><strong>ç±»åˆ«å¹³è¡¡ï¼š</strong>æ¯ä¸ªç±»åˆ«çš„å›¾ç‰‡æ•°é‡å°½é‡ç›¸åŒï¼Œé¿å…æ•°æ®å€¾æ–œ</li>
                            <li><strong>æ•°æ®å¢å¼ºï¼š</strong>å·²å¯ç”¨ç¿»è½¬å’Œäº®åº¦è°ƒæ•´ï¼Œæ•°æ®é‡å°†è‡ªåŠ¨æ‰©å¤§3å€</li>
                            <li><strong>è®­ç»ƒæ—¶é—´ï¼š</strong>å–å†³äºå›¾ç‰‡æ•°é‡ï¼Œæ¯ç±»20å¼ å›¾ç‰‡çº¦éœ€3-5åˆ†é’Ÿ</li>
                        </ul>
                    </div>
                </div>

            <!-- æ­¥éª¤1ï¼šåˆ›å»ºåˆ†ç±» -->
            <div class="step-section">
                <div class="step-title">
                    <div class="step-number">1</div>
                    <span>åˆ›å»ºåˆ†ç±»ç±»åˆ«</span>
                </div>
                <p>ä¸ºä½ çš„AIæ¨¡å‹åˆ›å»ºåˆ†ç±»ç±»åˆ«ã€‚ä¾‹å¦‚ï¼šçŒ«ã€ç‹—ã€æ±½è½¦ç­‰</p>
                <button class="add-class-btn" onclick="addClass()">â• æ·»åŠ æ–°ç±»åˆ«</button>
                <div class="classes-container" id="classesContainer">
                    <div class="class-card" data-class="0">
                        <div class="class-header">
                            <input type="text" class="class-name" value="ç±»åˆ«1" placeholder="è¾“å…¥ç±»åˆ«åç§°">
                            <button class="remove-class-btn" onclick="removeClass(0)">åˆ é™¤</button>
                        </div>
                        <div class="image-stats">å·²ä¸Šä¼ : <span class="image-count">0</span> å¼ å›¾ç‰‡</div>
                        <div class="image-upload" onclick="uploadImages(0)">
                            <div class="upload-icon">ğŸ“¸</div>
                            <p>ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„</p>
                            <input type="file" class="file-input" multiple accept="image/*" onchange="handleFileSelect(event, 0)">
                        </div>
                        <div class="image-preview" id="preview0"></div>
                    </div>
                    
                    <div class="class-card" data-class="1">
                        <div class="class-header">
                            <input type="text" class="class-name" value="ç±»åˆ«2" placeholder="è¾“å…¥ç±»åˆ«åç§°">
                            <button class="remove-class-btn" onclick="removeClass(1)">åˆ é™¤</button>
                        </div>
                        <div class="image-stats">å·²ä¸Šä¼ : <span class="image-count">0</span> å¼ å›¾ç‰‡</div>
                        <div class="image-upload" onclick="uploadImages(1)">
                            <div class="upload-icon">ğŸ“¸</div>
                            <p>ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„</p>
                            <input type="file" class="file-input" multiple accept="image/*" onchange="handleFileSelect(event, 1)">
                        </div>
                        <div class="image-preview" id="preview1"></div>
                    </div>
                </div>
            </div>
            
            <!-- æ­¥éª¤2ï¼šè®­ç»ƒæ¨¡å‹ -->
            <div class="step-section">
                <div class="step-title">
                    <div class="step-number">2</div>
                    <span>è¿ç§»å­¦ä¹ è®­ç»ƒ</span>
                </div>
                <div class="training-section">
                    <div class="training-details">
                        <strong>ğŸ§  ä½¿ç”¨æŠ€æœ¯ï¼š</strong><br>
                        â€¢ é¢„è®­ç»ƒæ¨¡å‹ï¼šMobileNet v2 (1280ç»´ç‰¹å¾)<br>
                        â€¢ åˆ†ç±»å™¨ï¼šè‡ªå®šä¹‰å…¨è¿æ¥å±‚<br>
                        â€¢ ä¼˜åŒ–å™¨ï¼šAdam (å­¦ä¹ ç‡: 0.0001)<br>
                        â€¢ æŸå¤±å‡½æ•°ï¼šåˆ†ç±»äº¤å‰ç†µ<br>
                        â€¢ è®­ç»ƒæ–¹å¼ï¼šæµè§ˆå™¨æœ¬åœ°è®­ç»ƒ<br>
                        â€¢ æ¨¡å‹åŠ è½½ï¼šæœ¬åœ°ä¼˜å…ˆï¼ŒCDNå›é€€
                    </div>
                    
                    
                    
                    <button class="train-btn" id="trainBtn" onclick="trainModel()">ğŸš€ å¼€å§‹çœŸå®è®­ç»ƒ</button>
                    <button class="train-btn" onclick="resetModel()" style="background: #ff4757;">ğŸ”„ é‡ç½®æ¨¡å‹</button>
                    
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <div class="status-message" id="statusMessage">ç­‰å¾…è®­ç»ƒå¼€å§‹...</div>
                    </div>
                    
                    <div class="model-metrics" id="modelMetrics" style="display: none;">
                        <div class="metric-card">
                            <div>å‡†ç¡®ç‡</div>
                            <div class="metric-value" id="accuracy">0%</div>
                        </div>
                        <div class="metric-card">
                            <div>è®­ç»ƒè½®æ•°</div>
                            <div class="metric-value" id="epochs">0/100</div>
                        </div>
                        <div class="metric-card">
                            <div>æŸå¤±å€¼</div>
                            <div class="metric-value" id="loss">0.00</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- æ­¥éª¤3ï¼šæµ‹è¯•æ¨¡å‹ -->
            <div class="step-section">
                <div class="step-title">
                    <div class="step-number">3</div>
                    <span>æµ‹è¯•ä½ çš„ä¸“ä¸šAIæ¨¡å‹</span>
                </div>
                <div class="prediction-section" id="predictionSection">
                    <p>ä¸Šä¼ ä¸€å¼ æ–°å›¾ç‰‡ï¼Œä½“éªŒä¸“ä¸šçº§çš„AIåˆ†ç±»æ•ˆæœï¼</p>
                    <div class="test-upload">
                        <div class="image-upload" onclick="uploadTestImage()">
                            <div class="upload-icon">ğŸ”</div>
                            <p>ä¸Šä¼ æµ‹è¯•å›¾ç‰‡</p>
                            <input type="file" class="file-input" accept="image/*" onchange="handleTestFile(event)">
                        </div>
                    </div>
                    <div class="test-preview" id="testPreview">
                        <img id="testImage" alt="æµ‹è¯•å›¾ç‰‡">
                    </div>
                    <div class="prediction-result" id="predictionResult">
                        <div style="text-align: center; color: #666; font-size: 1.2em;">
                            <p>ğŸ¯ ä¸Šä¼ å›¾ç‰‡åï¼Œè¿™é‡Œå°†æ˜¾ç¤ºAIçš„ä¸“ä¸šé¢„æµ‹ç»“æœï¼</p>
                            <p>æ¯ä¸ªç±»åˆ«éƒ½ä¼šæ˜¾ç¤ºç½®ä¿¡åº¦å’Œæ¦‚ç‡æ¡</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let mobilenetModel;
        let customModel;
        let classes = [];
        let trainingData = [];
        let classCount = 2;
        let isTraining = false;

        // åˆå§‹åŒ–
        async function init() {
            console.log('æ­£åœ¨åŠ è½½ä¸“ä¸šçº§é¢„è®­ç»ƒæ¨¡å‹...');
            document.getElementById('statusMessage').textContent = 'æ­£åœ¨åŠ è½½MobileNetæ¨¡å‹...';
            
            try {
                // è®¾ç½®è¶…æ—¶æ—¶é—´
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('åŠ è½½è¶…æ—¶')), 30000)
                );
                
                // å°è¯•å¤šç§åŠ è½½æ–¹å¼ï¼šæœ¬åœ° -> CDN
                mobilenetModel = await Promise.race([
                    loadModelWithFallback(),
                    timeoutPromise
                ]);
                
                console.log('MobileNetæ¨¡å‹åŠ è½½æˆåŠŸï¼');
                document.getElementById('statusMessage').textContent = 'æ¨¡å‹å·²å°±ç»ªï¼Œè¯·ä¸Šä¼ å›¾ç‰‡å¼€å§‹è®­ç»ƒï¼';
                
                // é¢„çƒ­æ¨¡å‹
                const dummyTensor = tf.zeros([1, 224, 224, 3]);
                await mobilenetModel.infer(dummyTensor, 'conv_preds');
                dummyTensor.dispose();
                
            } catch (error) {
                console.error('æ¨¡å‹åŠ è½½å¤±è´¥:', error);
                handleModelLoadError(error);
            }
        }

        // æ™ºèƒ½æ¨¡å‹åŠ è½½ï¼ˆæœ¬åœ°ä¼˜å…ˆï¼ŒCDNå›é€€ï¼‰
        async function loadModelWithFallback() {
            const loadingMethods = [
                // æ–¹æ³•1ï¼šæœ¬åœ°æ¨¡å‹
                async () => {
                    console.log('å°è¯•åŠ è½½æœ¬åœ°MobileNetæ¨¡å‹...');
                    try {
                        return await mobilenet.load({
                            modelUrl: './models/mobilenet_v2/model.json'
                        });
                    } catch (localError) {
                        console.log('æœ¬åœ°æ¨¡å‹æœªæ‰¾åˆ°ï¼Œå°è¯•CDN...');
                        throw localError;
                    }
                },
                // æ–¹æ³•2ï¼šCDNåŠ è½½
                async () => {
                    console.log('åŠ è½½CDN MobileNetæ¨¡å‹...');
                    return await mobilenet.load();
                }
            ];

            // ä¾æ¬¡å°è¯•æ¯ç§åŠ è½½æ–¹å¼
            for (const method of loadingMethods) {
                try {
                    return await method();
                } catch (error) {
                    console.warn('åŠ è½½æ–¹å¼å¤±è´¥:', error.message);
                    if (method === loadingMethods[loadingMethods.length - 1]) {
                        throw error;
                    }
                }
            }
        }

        // é”™è¯¯å¤„ç†
        function handleModelLoadError(error) {
            let errorMessage = '';
            let solution = '';
            
            if (error.message.includes('timeout')) {
                errorMessage = 'åŠ è½½è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œé€Ÿåº¦';
                solution = 'å»ºè®®ä½¿ç”¨æœ¬åœ°æ¨¡å‹æˆ–æ£€æŸ¥ç½‘ç»œè¿æ¥';
            } else if (error.message.includes('fetch')) {
                errorMessage = 'ç½‘ç»œè¿æ¥é—®é¢˜ï¼Œæ— æ³•è®¿é—®æ¨¡å‹æ–‡ä»¶';
                solution = 'å·²ä¸ºæ‚¨å¯ç”¨æœ¬åœ°æ¨¡å‹å¤‡ä»½æ–¹æ¡ˆ';
            } else if (error.message.includes('404') || error.message.includes('not found')) {
                errorMessage = 'æ¨¡å‹æ–‡ä»¶æœªæ‰¾åˆ°';
                solution = 'è¯·ä¸‹è½½æœ¬åœ°æ¨¡å‹æ–‡ä»¶æˆ–ç¡®ä¿ç½‘ç»œè¿æ¥æ­£å¸¸';
            } else {
                errorMessage = 'æœªçŸ¥é”™è¯¯ï¼š' + error.message;
                solution = 'è¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°è·å–è¯¦ç»†ä¿¡æ¯';
            }
            
            document.getElementById('statusMessage').innerHTML = `
                <div style="color: #ff4757; font-weight: bold; margin-bottom: 15px;">
                    âŒ æ¨¡å‹åŠ è½½å¤±è´¥ï¼š${errorMessage}
                </div>
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;">
                    <h4 style="color: #856404; margin-bottom: 10px;">ğŸ”§ è§£å†³æ–¹æ¡ˆ</h4>
                    <p style="margin: 0 0 10px 0; color: #856404;"><strong>${solution}</strong></p>
                    <ul style="margin: 0; padding-left: 20px; color: #856404; line-height: 1.6;">
                        <li><strong>æœ¬åœ°æ¨¡å‹ï¼š</strong>å·²é…ç½®æœ¬åœ°æ¨¡å‹è·¯å¾„ ./models/mobilenet_v2/</li>
                        <li><strong>ç½‘ç»œæ£€æŸ¥ï¼š</strong>ç¡®è®¤å¯ä»¥è®¿é—®å¤–ç½‘</li>
                        <li><strong>åˆ·æ–°é¡µé¢ï¼š</strong>æŒ‰ Ctrl+F5 å¼ºåˆ¶åˆ·æ–°æµè§ˆå™¨ç¼“å­˜</li>
                        <li><strong>æµè§ˆå™¨ï¼š</strong>ä½¿ç”¨Chromeæˆ–Edgeæœ€æ–°ç‰ˆæœ¬</li>
                    </ul>
                </div>
                <div style="margin-top: 15px; font-size: 0.9em; color: #666;">
                    <strong>æŠ€æœ¯ä¿¡æ¯ï¼š</strong><br>
                    é”™è¯¯ç±»å‹ï¼š${error.name}<br>
                    é”™è¯¯è¯¦æƒ…ï¼š${error.message.substring(0, 100)}...
                </div>
            `;
            
            // ç¦ç”¨è®­ç»ƒæŒ‰é’®
            document.getElementById('trainBtn').disabled = true;
            document.getElementById('trainBtn').style.opacity = '0.5';
            document.getElementById('trainBtn').textContent = 'æ¨¡å‹æœªåŠ è½½';
            
            // æ·»åŠ é‡è¯•æŒ‰é’®
            const retryBtn = document.createElement('button');
            retryBtn.textContent = 'ğŸ”„ é‡æ–°åŠ è½½æ¨¡å‹';
            retryBtn.style.cssText = 'background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px;';
            retryBtn.onclick = () => {
                document.getElementById('statusMessage').textContent = 'æ­£åœ¨é‡æ–°åŠ è½½...';
                setTimeout(init, 1000);
            };
            
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.appendChild(document.createElement('br'));
            statusDiv.appendChild(retryBtn);
        }

        // åˆ›å»ºå¢å¼ºçš„è‡ªå®šä¹‰åˆ†ç±»æ¨¡å‹
        function createModel(numClasses) {
            const model = tf.sequential({
                layers: [
                    tf.layers.dense({
                        units: 512,
                        activation: 'relu',
                        kernelInitializer: 'varianceScaling',
                        useBias: true,
                        inputShape: [1024]
                    }),
                    tf.layers.batchNormalization(),
                    tf.layers.dropout({ rate: 0.3 }),
                    tf.layers.dense({
                        units: 256,
                        activation: 'relu',
                        kernelInitializer: 'varianceScaling',
                        useBias: true
                    }),
                    tf.layers.batchNormalization(),
                    tf.layers.dropout({ rate: 0.3 }),
                    tf.layers.dense({
                        units: 128,
                        activation: 'relu',
                        kernelInitializer: 'varianceScaling',
                        useBias: true
                    }),
                    tf.layers.dropout({ rate: 0.2 }),
                    tf.layers.dense({
                        units: numClasses,
                        activation: 'softmax',
                        kernelInitializer: 'varianceScaling',
                        useBias: true
                    })
                ]
            });

            model.compile({
                optimizer: tf.train.adam(0.0001),
                loss: 'categoricalCrossentropy',
                metrics: ['accuracy']
            });

            return model;
        }

        // æ•°æ®å¢å¼ºï¼šä»…ä¿ç•™ç®€å•çš„éšæœºç¿»è½¬
         function augmentImage(imgElement) {
             return tf.tidy(() => {
                 let tensor = tf.browser.fromPixels(imgElement)
                     .resizeNearestNeighbor([224, 224])
                     .toFloat()
                     .div(255.0)
                     .expandDims(0);
 
                 // éšæœºæ°´å¹³ç¿»è½¬ï¼ˆç®€å•ä¸”æœ‰æ•ˆï¼‰
                 if (Math.random() > 0.5) {
                     tensor = tensor.reverse(2);
                 }
 
                 // éšæœºå‚ç›´ç¿»è½¬
                 if (Math.random() > 0.5) {
                     tensor = tensor.reverse(1);
                 }
 
                 // éšæœºäº®åº¦è°ƒæ•´ï¼ˆè½»å¾®å˜åŒ–ï¼‰
                 if (Math.random() > 0.5) {
                     const brightness = 0.9 + Math.random() * 0.2; // 0.9-1.1å€
                     tensor = tensor.mul(brightness).clipByValue(0, 1);
                 }
 
                 return tensor;
             });
         }

        // é¢„å¤„ç†å›¾ç‰‡ï¼ˆæ— å¢å¼ºï¼‰
        function preprocessImage(imgElement) {
            return tf.tidy(() => {
                const tensor = tf.browser.fromPixels(imgElement)
                    .resizeNearestNeighbor([224, 224])
                    .toFloat()
                    .div(255.0)
                    .expandDims(0);
                const features = mobilenetModel.infer(tensor, 'conv_preds');
                return features.squeeze();
            });
        }

        // æ·»åŠ æ–°ç±»åˆ«
        function addClass() {
            const container = document.getElementById('classesContainer');
            const newClass = document.createElement('div');
            newClass.className = 'class-card';
            newClass.setAttribute('data-class', classCount);
            newClass.innerHTML = `
                <div class="class-header">
                    <input type="text" class="class-name" value="ç±»åˆ«${classCount + 1}" placeholder="è¾“å…¥ç±»åˆ«åç§°">
                    <button class="remove-class-btn" onclick="removeClass(${classCount})">åˆ é™¤</button>
                </div>
                <div class="image-stats">å·²ä¸Šä¼ : <span class="image-count">0</span> å¼ å›¾ç‰‡</div>
                <div class="image-upload" onclick="uploadImages(${classCount})">
                    <div class="upload-icon">ğŸ“¸</div>
                    <p>ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„</p>
                    <input type="file" class="file-input" multiple accept="image/*" onchange="handleFileSelect(event, ${classCount})">
                </div>
                <div class="image-preview" id="preview${classCount}"></div>
            `;
            container.appendChild(newClass);
            classCount++;
            setupDragDrop();
        }

        // åˆ é™¤ç±»åˆ«
        function removeClass(index) {
            if (document.querySelectorAll('.class-card').length <= 2) {
                alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸¤ä¸ªç±»åˆ«ï¼');
                return;
            }
            const card = document.querySelector(`[data-class="${index}"]`);
            card.remove();
        }

        // ä¸Šä¼ å›¾ç‰‡
        function uploadImages(classIndex) {
            document.querySelector(`[data-class="${classIndex}"] .file-input`).click();
        }

        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        async function handleFileSelect(event, classIndex) {
            const files = Array.from(event.target.files);
            const preview = document.getElementById(`preview${classIndex}`);
            const imageCount = preview.querySelectorAll('.preview-item').length;
            
            for (const file of files) {
                if (file.type.startsWith('image/')) {
                    const img = new Image();
                    img.onload = function() {
                        const previewItem = document.createElement('div');
                        previewItem.className = 'preview-item';
                        previewItem.innerHTML = `
                            <img src="${URL.createObjectURL(file)}" alt="é¢„è§ˆ">
                            <button class="remove-btn" onclick="this.parentElement.remove(); updateImageCount(${classIndex})">Ã—</button>
                        `;
                        preview.appendChild(previewItem);
                        updateImageCount(classIndex);
                    };
                    img.src = URL.createObjectURL(file);
                }
            }
        }

        // æ›´æ–°å›¾ç‰‡è®¡æ•°
        function updateImageCount(classIndex) {
            const card = document.querySelector(`[data-class="${classIndex}"]`);
            const count = card.querySelectorAll('.preview-item').length;
            card.querySelector('.image-count').textContent = count;
        }

        // è®¾ç½®æ‹–æ‹½ä¸Šä¼ 
        function setupDragDrop() {
            document.querySelectorAll('.image-upload').forEach(upload => {
                upload.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.classList.add('dragover');
                });
                
                upload.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    this.classList.remove('dragover');
                });
                
                upload.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('dragover');
                    
                    const files = Array.from(e.dataTransfer.files);
                    const classIndex = this.closest('.class-card').getAttribute('data-class');
                    const preview = document.getElementById(`preview${classIndex}`);
                    
                    files.forEach(file => {
                        if (file.type.startsWith('image/')) {
                            const img = new Image();
                            img.onload = function() {
                                const previewItem = document.createElement('div');
                                previewItem.className = 'preview-item';
                                previewItem.innerHTML = `
                                    <img src="${URL.createObjectURL(file)}" alt="é¢„è§ˆ">
                                    <button class="remove-btn" onclick="this.parentElement.remove(); updateImageCount(${classIndex})">Ã—</button>
                                `;
                                preview.appendChild(previewItem);
                                updateImageCount(classIndex);
                            };
                            img.src = URL.createObjectURL(file);
                        }
                    });
                });
            });
        }

        // è®­ç»ƒæ¨¡å‹
        async function trainModel() {
            if (isTraining) return;
            
            const classCards = document.querySelectorAll('.class-card');
            let totalImages = 0;
            trainingData = [];
            classes = [];
            
            // æ”¶é›†è®­ç»ƒæ•°æ®
            for (const card of classCards) {
                const classIndex = parseInt(card.getAttribute('data-class'));
                const className = card.querySelector('.class-name').value;
                const images = card.querySelectorAll('.preview-item img');
                
                if (images.length < 8) {
                    alert(`ç±»åˆ« "${className}" è‡³å°‘éœ€è¦8å¼ å›¾ç‰‡ï¼`);
                    return;
                }
                
                classes.push({ index: classIndex, name: className });
                
                for (const img of images) {
                    trainingData.push({
                        image: img,
                        label: classIndex,
                        className: className
                    });
                    totalImages++;
                }
            }
            
            if (classes.length < 2) {
                alert('è‡³å°‘éœ€è¦ä¸¤ä¸ªç±»åˆ«ï¼');
                return;
            }
            
            console.log(`å¼€å§‹è®­ç»ƒ - ç±»åˆ«æ•°: ${classes.length}, æ€»å›¾ç‰‡æ•°: ${totalImages}, å¢å¼ºåæ ·æœ¬æ•°: ${totalImages * 3}`);
            const startTime = Date.now();
            
            // è®­ç»ƒå‰æ£€æŸ¥å’Œæç¤º
            const originalImages = trainingData.length;
            const augmentedImages = originalImages * 3;
            
            let timeEstimate = "âš¡ å¿«é€Ÿè®­ç»ƒ";
            let warning = "";
            
            if (originalImages < 20) {
                timeEstimate = "âš¡ è¶…å¿«è®­ç»ƒ";
                warning = "âš ï¸ æ•°æ®é‡è¾ƒå°‘ï¼Œè®­ç»ƒä¼šéå¸¸å¿«ï¼Œä½†å¯èƒ½å½±å“å‡†ç¡®æ€§";
            } else if (originalImages < 50) {
                timeEstimate = "ğŸš€ æ­£å¸¸è®­ç»ƒ";
                warning = "âœ… æ•°æ®é‡é€‚ä¸­ï¼Œè®­ç»ƒæ—¶é—´æ­£å¸¸";
            } else {
                timeEstimate = "â³ æ·±åº¦è®­ç»ƒ";
                warning = "ğŸ”¥ æ•°æ®é‡å……è¶³ï¼Œè®­ç»ƒæ—¶é—´è¾ƒé•¿ä½†æ•ˆæœæ›´å¥½";
            }
            
            const estimatedTotalTime = Math.max(3, Math.ceil(augmentedImages * 0.05));
            
            console.log(`${timeEstimate} - ${warning}`);
            console.log(`é¢„è®¡æ€»è®­ç»ƒæ—¶é—´: ${estimatedTotalTime}-${estimatedTotalTime * 2}ç§’`);
            
            isTraining = true;
            document.getElementById('trainBtn').disabled = true;
            document.getElementById('statusMessage').textContent = 
                `${timeEstimate} - ${warning} é¢„è®¡${estimatedTotalTime}-${estimatedTotalTime * 2}ç§’`;
            document.getElementById('modelMetrics').style.display = 'grid';
            
            try {
                // åˆ›å»ºæ¨¡å‹
                customModel = createModel(classes.length);
                
                // å‡†å¤‡è®­ç»ƒæ•°æ®
                const { xs, ys } = await prepareTrainingData();
                
                // è®­ç»ƒæ¨¡å‹
                await trainCustomModel(xs, ys);
                
                const endTime = Date.now();
                const trainingTime = ((endTime - startTime) / 1000).toFixed(1);
                
                document.getElementById('predictionSection').style.display = 'block';
                document.getElementById('statusMessage').textContent = `è®­ç»ƒå®Œæˆï¼å®é™…è®­ç»ƒæ—¶é—´: ${trainingTime}ç§’`;
                console.log(`è®­ç»ƒå®Œæˆ - å®é™…ç”¨æ—¶: ${trainingTime}ç§’`);
                
            } catch (error) {
                console.error('è®­ç»ƒå¤±è´¥:', error);
                document.getElementById('statusMessage').textContent = 'è®­ç»ƒå¤±è´¥: ' + error.message;
            } finally {
                isTraining = false;
                document.getElementById('trainBtn').disabled = false;
            }
        }

        // å‡†å¤‡è®­ç»ƒæ•°æ®ï¼ˆå¸¦å¢å¼ºï¼‰
        async function prepareTrainingData() {
            const statusMessage = document.getElementById('statusMessage');
            
            const xs = [];
            const ys = [];
            
            // æ¯å¼ ç…§ç‰‡ç”Ÿæˆ3ä¸ªå¢å¼ºç‰ˆæœ¬
            const augmentFactor = 3;
            const totalSteps = trainingData.length * augmentFactor;
            
            // æ•°æ®é‡æ£€æŸ¥å’Œæ—¶é—´é¢„ä¼°
            const originalImages = trainingData.length;
            const augmentedImages = originalImages * augmentFactor;
            const estimatedFeatureTime = Math.ceil(originalImages * 0.2);
            const estimatedAugmentTime = Math.ceil(augmentedImages * 0.1);
            
            console.log(`æ•°æ®å‡†å¤‡å¼€å§‹ - åŸå§‹å›¾ç‰‡: ${originalImages}, å¢å¼ºå: ${augmentedImages}`);
            console.log(`é¢„è®¡ç‰¹å¾æå–æ—¶é—´: ${estimatedFeatureTime}ç§’, æ•°æ®å¢å¼ºæ—¶é—´: ${estimatedAugmentTime}ç§’`);
            
            statusMessage.textContent = `æ­£åœ¨æå–ç‰¹å¾... é¢„è®¡éœ€è¦ ${estimatedFeatureTime + estimatedAugmentTime}ç§’`;
            
            let step = 0;
            
            for (const data of trainingData) {
                // åŸå§‹å›¾ç‰‡
                const features = preprocessImage(data.image);
                xs.push(features.expandDims(0));
                const label = tf.tidy(() => tf.oneHot([data.label], classes.length));
                ys.push(label);
                
                // å¢å¼ºç‰ˆæœ¬ - å¢åŠ å»¶è¿Ÿè®©è¿‡ç¨‹æ›´æ˜æ˜¾
                for (let aug = 0; aug < augmentFactor - 1; aug++) {
                    const augTensor = augmentImage(data.image);
                    const augFeatures = mobilenetModel.infer(augTensor, 'conv_preds').squeeze();
                    xs.push(augFeatures.expandDims(0));
                    ys.push(label);
                    
                    step++;
                    const progress = (step / totalSteps) * 100;
                    document.getElementById('progressFill').style.width = `${progress * 0.3}%`;
                    
                    // å¢åŠ å»¶è¿Ÿè®©ç”¨æˆ·çœ‹åˆ°è¿‡ç¨‹
                    await new Promise(resolve => setTimeout(resolve, 50 + Math.random() * 100));
                    
                    // æ¸…ç†ä¸­é—´å¼ é‡
                    augTensor.dispose();
                }
                
                step++;
                const progress = (step / totalSteps) * 100;
                document.getElementById('progressFill').style.width = `${progress * 0.3}%`;
            }
            
            const xsTensor = tf.concat(xs, 0);
            const ysTensor = tf.concat(ys, 0);
            
            xs.forEach(x => x.dispose());
            ys.forEach(y => y.dispose());
            
            console.log(`æ•°æ®å‡†å¤‡å®Œæˆ - æœ€ç»ˆè®­ç»ƒæ ·æœ¬: ${xsTensor.shape[0]}ä¸ª`);
            return { xs: xsTensor, ys: ysTensor };
        }

        // è®­ç»ƒè‡ªå®šä¹‰æ¨¡å‹
        async function trainCustomModel(xs, ys) {
            const statusMessage = document.getElementById('statusMessage');
            const epochs = 100;
            
            console.log(`å¼€å§‹è®­ç»ƒ - æ ·æœ¬ç»´åº¦: ${xs.shape}, æ‰¹æ¬¡å¤§å°: ${Math.min(Math.floor(xs.shape[0] * 0.4), 32)}`);
            
            await customModel.fit(xs, ys, {
                epochs: epochs,
                batchSize: Math.min(Math.floor(xs.shape[0] * 0.4), 32),
                validationSplit: 0.2,
                callbacks: {
                    onEpochBegin: async (epoch) => {
                        if (epoch === 0) {
                            console.log(`ç¬¬1è½®å¼€å§‹ - é¢„è®¡æ€»æ—¶é—´: ${Math.ceil(epochs * 0.1)}-${Math.ceil(epochs * 0.3)}ç§’`);
                        }
                    },
                    onEpochEnd: async (epoch, logs) => {
                        const progress = 30 + ((epoch + 1) / epochs) * 70;
                        document.getElementById('progressFill').style.width = `${progress}%`;
                        document.getElementById('epochs').textContent = `${epoch + 1}/${epochs}`;
                        document.getElementById('loss').textContent = logs.loss.toFixed(3);
                        document.getElementById('accuracy').textContent = `${(logs.acc * 100).toFixed(1)}%`;
                        
                        const estimatedRemaining = ((epochs - epoch - 1) * 0.15).toFixed(1);
                        statusMessage.textContent = `è®­ç»ƒä¸­... ç¬¬ ${epoch + 1}/${epochs} è½® (é¢„è®¡å‰©ä½™ ${estimatedRemaining}ç§’)`;
                        
                        console.log(`ç¬¬${epoch + 1}è½® - æŸå¤±: ${logs.loss.toFixed(4)}, å‡†ç¡®ç‡: ${(logs.acc * 100).toFixed(1)}%`);
                        
                        // å¢åŠ å»¶è¿Ÿè®©ç”¨æˆ·çœ‹åˆ°è®­ç»ƒè¿‡ç¨‹
                        await new Promise(resolve => setTimeout(resolve, 100 + Math.random() * 50));
                    }
                }
            });
            
            xs.dispose();
            ys.dispose();
        }

        // é‡ç½®æ¨¡å‹
        function resetModel() {
            if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰è®­ç»ƒæ•°æ®å—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰è®­ç»ƒç»“æœã€‚')) {
                if (customModel) {
                    customModel.dispose();
                    customModel = null;
                }
                
                document.querySelectorAll('.image-preview').forEach(preview => {
                    preview.innerHTML = '';
                });
                document.querySelectorAll('.image-count').forEach(count => {
                    count.textContent = '0';
                });
                document.getElementById('predictionSection').style.display = 'none';
                document.getElementById('statusMessage').textContent = 'æ¨¡å‹å·²é‡ç½®ï¼Œè¯·é‡æ–°ä¸Šä¼ å›¾ç‰‡ã€‚';
                document.getElementById('progressFill').style.width = '0%';
                document.getElementById('modelMetrics').style.display = 'none';
            }
        }

        // ä¸Šä¼ æµ‹è¯•å›¾ç‰‡
        function uploadTestImage() {
            document.querySelector('#predictionSection .file-input').click();
        }

        // å¤„ç†æµ‹è¯•æ–‡ä»¶
        function handleTestFile(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const img = new Image();
                img.onload = function() {
                    const testPreview = document.getElementById('testPreview');
                    const testImage = document.getElementById('testImage');
                    testImage.src = URL.createObjectURL(file);
                    testPreview.style.display = 'block';
                    predictImage(img);
                };
                img.src = URL.createObjectURL(file);
            }
        }

        // é¢„æµ‹å›¾ç‰‡
    async function predictImage(imgElement) {
        if (!customModel || !imgElement) {
            alert('è¯·å…ˆè®­ç»ƒæ¨¡å‹å¹¶ä¸Šä¼ æµ‹è¯•å›¾ç‰‡ï¼');
            return;
        }

        try {
            const features = preprocessImage(imgElement);
            const predictions = customModel.predict(features.expandDims(0));
            const probs = await predictions.data();
            
            const results = classes.map((cls, index) => ({
                className: cls.name,
                confidence: probs[index]
            })).sort((a, b) => b.confidence - a.confidence);

            const predictionResult = document.getElementById('predictionResult');
            let html = '<h3>ğŸ¯ ä¸“ä¸šé¢„æµ‹ç»“æœ</h3><div class="prediction-result">';
            
            results.forEach((result, index) => {
                const percentage = Math.round(result.confidence * 100);
                const isWinner = index === 0;
                
                html += `
                        <div class="result-card ${isWinner ? 'winner' : ''}">
                            <h4>${result.className}</h4>
                            <div class="confidence-bar">
                                <div class="confidence-fill" style="width: ${percentage}%"></div>
                            </div>
                            <p>${percentage}%</p>
                            ${isWinner ? '<div>ğŸ† æœ€ä½³åŒ¹é…</div>' : ''}
                        </div>
                    `;
            });
            
            html += '</div>';
            html += `<div style="text-align: center; margin-top: 20px; font-size: 1.3em; color: #4CAF50; font-weight: bold;">
                ğŸ‰ AIé¢„æµ‹ç»“æœ: <span style="color: #FFD700;">${results[0].className}</span> çš„å¯èƒ½æ€§æœ€é«˜ï¼
            </div>`;
            
            predictionResult.innerHTML = html;
            
            features.dispose();
            predictions.dispose();
        } catch (error) {
            console.error('é¢„æµ‹å‡ºé”™:', error);
            alert('é¢„æµ‹è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—');
        }
    }

        // åˆå§‹åŒ–é¡µé¢
        init();
        setupDragDrop();
    </script>
</body>
</html>